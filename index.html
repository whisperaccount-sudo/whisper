<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Whisper</title>
  <meta name="description" content="Create intimate message sequences">
  <meta name="theme-color" content="#1B171E">
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1B171E;
      color: #F7F3EF;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .header h1 {
      font-size: 48px;
      font-weight: 300;
      color: #EFD9DC;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }
    
    .header p {
      color: #A08BAA;
      font-size: 14px;
    }
    
    .btn {
      padding: 16px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #A08BAA 0%, #EFD9DC 100%);
      color: #1B171E;
      width: 100%;
      padding: 20px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-secondary {
      background: transparent;
      border: 1px solid #A08BAA;
      color: #A08BAA;
    }
    
    .btn-text {
      background: transparent;
      border: none;
      color: #A08BAA;
      cursor: pointer;
      padding: 8px 0;
      font-size: 14px;
    }
    
    .card {
      background: #2A242C;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(160, 139, 170, 0.1);
      margin-bottom: 16px;
    }
    
    .card h3 {
      font-size: 20px;
      color: #EFD9DC;
      font-weight: 500;
      margin-bottom: 12px;
    }
    
    .card-actions {
      display: flex;
      gap: 8px;
    }
    
    .icon-btn {
      background: transparent;
      border: none;
      color: #A08BAA;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
    }
    
    .icon-btn:hover {
      background: rgba(160, 139, 170, 0.1);
    }
    
    input[type="text"], textarea {
      width: 100%;
      background: #2A242C;
      border: 1px solid rgba(160, 139, 170, 0.2);
      border-radius: 8px;
      padding: 16px;
      color: #EFD9DC;
      font-size: 16px;
      outline: none;
    }
    
    textarea {
      font-family: Georgia, serif;
      min-height: 100px;
      resize: vertical;
      background: #1B171E;
    }
    
    .slide-editor {
      background: #2A242C;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(160, 139, 170, 0.1);
      margin-bottom: 16px;
    }
    
    .slide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .slide-number {
      color: #A08BAA;
      font-size: 14px;
      font-weight: 600;
    }
    
    .viewer-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
    }
    
    .viewer-title {
      font-size: 28px;
      color: #EFD9DC;
      margin-bottom: 40px;
      font-weight: 300;
      letter-spacing: 1px;
      text-align: center;
    }
    
    .slide-content {
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px 40px;
      background: rgba(42, 36, 44, 0.5);
      border-radius: 16px;
      border: 1px solid rgba(160, 139, 170, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      max-width: 700px;
      width: 100%;
    }
    
    .slide-text {
      font-size: 24px;
      line-height: 1.6;
      color: #F7F3EF;
      font-family: Georgia, serif;
      font-style: italic;
      text-align: center;
    }
    
    .progress-dots {
      margin-top: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .dot.active {
      background: #EFD9DC;
    }
    
    .dot.inactive {
      background: rgba(160, 139, 170, 0.3);
    }
    
    .position-btn {
      position: absolute;
      top: 20px;
      background: rgba(42, 36, 44, 0.8);
      border: none;
      color: #A08BAA;
      cursor: pointer;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .position-btn.left {
      left: 20px;
    }
    
    .position-btn.right {
      right: 20px;
    }
    
    .position-btn.copied {
      color: #EFD9DC;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #A08BAA;
      font-size: 14px;
    }
    
    .add-slide-btn {
      width: 100%;
      padding: 16px;
      background: #2A242C;
      border: 2px dashed rgba(160, 139, 170, 0.3);
      border-radius: 8px;
      color: #A08BAA;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // Storage utilities
    const STORAGE_KEY = 'whisper_app_data';
    
    const getWhispers = () => {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
      } catch {
        return [];
      }
    };
    
    const saveWhispers = (whispers) => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(whispers));
    };
    
    const createWhisper = () => ({
      id: Date.now().toString(),
      title: 'Untitled Whisper',
      theme: 'whisperA',
      slides: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    });
    
    // Router
    class Router {
      constructor() {
        this.handlers = {};
        this.currentRoute = this.getRoute();
        
        window.addEventListener('hashchange', () => {
          this.currentRoute = this.getRoute();
          this.render();
        });
      }
      
      getRoute() {
        const hash = window.location.hash.slice(1) || '/';
        const [, page, id] = hash.match(/^\/([^/]+)(?:\/(.+))?$/) || ['/', '', ''];
        return { page: page || 'list', id };
      }
      
      navigate(path) {
        window.location.hash = path;
      }
      
      on(page, handler) {
        this.handlers[page] = handler;
      }
      
      render() {
        const handler = this.handlers[this.currentRoute.page];
        if (handler) {
          handler(this.currentRoute.id);
        }
      }
    }
    
    const router = new Router();
    
    // List page
    router.on('list', () => {
      const whispers = getWhispers();
      
      document.getElementById('app').innerHTML = `
        <div class="container">
          <header class="header">
            <h1>Whisper</h1>
            <p>Create intimate message sequences</p>
          </header>
          
          <button class="btn btn-primary" onclick="router.navigate('/edit/new')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Whisper
          </button>
          
          <div style="margin-top: 32px;">
            ${whispers.length === 0 ? '<div class="empty-state">No whispers yet. Create your first one above.</div>' : ''}
            ${whispers.map(w => `
              <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <h3>${w.title}</h3>
                  <div class="card-actions">
                    <button class="icon-btn" onclick="router.navigate('/edit/${w.id}')" title="Edit">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button class="icon-btn" onclick="router.navigate('/view/${w.id}')" title="View">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>
                    <button class="icon-btn" onclick="deleteWhisper('${w.id}')" title="Delete">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </div>
                </div>
                <p style="color: #A08BAA; font-size: 14px; margin-top: 12px;">
                  ${w.slides.length} slide${w.slides.length !== 1 ? 's' : ''}
                </p>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    });
    
    // Delete whisper
    window.deleteWhisper = (id) => {
      if (confirm('Delete this Whisper?')) {
        const whispers = getWhispers().filter(w => w.id !== id);
        saveWhispers(whispers);
        router.render();
      }
    };
    
    // Editor page
    let currentWhisper = null;
    
    router.on('edit', (id) => {
      if (id === 'new') {
        currentWhisper = createWhisper();
      } else {
        const whispers = getWhispers();
        currentWhisper = whispers.find(w => w.id === id);
        if (!currentWhisper) {
          router.navigate('/');
          return;
        }
      }
      
      renderEditor();
    });
    
    const renderEditor = () => {
      document.getElementById('app').innerHTML = `
        <div class="container">
          <button class="btn-text" onclick="router.navigate('/')">← Back to list</button>
          
          <div style="margin-top: 16px; margin-bottom: 32px;">
            <input 
              type="text" 
              id="whisper-title" 
              value="${currentWhisper.title}" 
              placeholder="Whisper title..."
              style="margin-bottom: 16px; font-size: 24px; font-weight: 500;"
              oninput="updateTitle(this.value)"
            />
            
            <button class="btn btn-primary" onclick="saveWhisper()">
              Save & Return
            </button>
          </div>
          
          <button class="add-slide-btn" onclick="addSlide()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Slide
          </button>
          
          <div id="slides-container">
            ${renderSlides()}
          </div>
        </div>
      `;
    };
    
    const renderSlides = () => {
      return currentWhisper.slides.map((slide, index) => `
        <div class="slide-editor">
          <div class="slide-header">
            <span class="slide-number">Slide ${index + 1}</span>
            <div style="display: flex; gap: 8px;">
              <button 
                class="icon-btn" 
                onclick="moveSlide('${slide.id}', 'up')" 
                ${index === 0 ? 'disabled style="color: #3A343C; cursor: not-allowed;"' : ''}
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
              </button>
              <button 
                class="icon-btn" 
                onclick="moveSlide('${slide.id}', 'down')" 
                ${index === currentWhisper.slides.length - 1 ? 'disabled style="color: #3A343C; cursor: not-allowed;"' : ''}
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <button class="icon-btn" onclick="deleteSlide('${slide.id}')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
          <textarea 
            placeholder="Write your message..."
            oninput="updateSlide('${slide.id}', this.value)"
          >${slide.text}</textarea>
        </div>
      `).join('');
    };
    
    window.updateTitle = (title) => {
      currentWhisper.title = title;
    };
    
    window.addSlide = () => {
      const newSlide = {
        id: Date.now().toString(),
        text: '',
        order: currentWhisper.slides.length
      };
      currentWhisper.slides.push(newSlide);
      renderEditor();
    };
    
    window.updateSlide = (slideId, text) => {
      const slide = currentWhisper.slides.find(s => s.id === slideId);
      if (slide) slide.text = text;
    };
    
    window.deleteSlide = (slideId) => {
      currentWhisper.slides = currentWhisper.slides
        .filter(s => s.id !== slideId)
        .map((s, i) => ({ ...s, order: i }));
      renderEditor();
    };
    
    window.moveSlide = (slideId, direction) => {
      const index = currentWhisper.slides.findIndex(s => s.id === slideId);
      if (direction === 'up' && index > 0) {
        [currentWhisper.slides[index], currentWhisper.slides[index - 1]] = 
        [currentWhisper.slides[index - 1], currentWhisper.slides[index]];
        currentWhisper.slides = currentWhisper.slides.map((s, i) => ({ ...s, order: i }));
        renderEditor();
      } else if (direction === 'down' && index < currentWhisper.slides.length - 1) {
        [currentWhisper.slides[index], currentWhisper.slides[index + 1]] = 
        [currentWhisper.slides[index + 1], currentWhisper.slides[index]];
        currentWhisper.slides = currentWhisper.slides.map((s, i) => ({ ...s, order: i }));
        renderEditor();
      }
    };
    
    window.saveWhisper = () => {
      const whispers = getWhispers();
      currentWhisper.updatedAt = new Date().toISOString();
      const index = whispers.findIndex(w => w.id === currentWhisper.id);
      
      if (index >= 0) {
        whispers[index] = currentWhisper;
      } else {
        whispers.push(currentWhisper);
      }
      
      saveWhispers(whispers);
      router.navigate('/');
    };
    
    // Viewer page
    let viewerState = { whisper: null, currentSlide: 0, copied: false };
    
    router.on('view', (id) => {
      const whispers = getWhispers();
      viewerState.whisper = whispers.find(w => w.id === id);
      viewerState.currentSlide = 0;
      viewerState.copied = false;
      
      if (!viewerState.whisper) {
        router.navigate('/');
        return;
      }
      
      // Update meta tags
      document.title = `${viewerState.whisper.title} - Whisper`;
      updateMetaTags(viewerState.whisper);
      
      renderViewer();
    });
    
    const updateMetaTags = (whisper) => {
      const existingMeta = document.querySelectorAll('meta[property^="og:"], meta[name="twitter:"]');
      existingMeta.forEach(tag => tag.remove());
      
      const metaTags = [
        { property: 'og:title', content: whisper.title },
        { property: 'og:description', content: "You've received a Whisper" },
        { property: 'og:type', content: 'website' },
        { property: 'og:site_name', content: 'Whisper' },
        { name: 'twitter:card', content: 'summary' },
        { name: 'twitter:title', content: whisper.title },
        { name: 'twitter:description', content: "You've received a Whisper" }
      ];
      
      metaTags.forEach(({ property, name, content }) => {
        const meta = document.createElement('meta');
        if (property) meta.setAttribute('property', property);
        if (name) meta.setAttribute('name', name);
        meta.setAttribute('content', content);
        document.head.appendChild(meta);
      });
    };
    
    const renderViewer = () => {
      const { whisper, currentSlide, copied } = viewerState;
      const slide = whisper.slides[currentSlide];
      
      document.getElementById('app').innerHTML = `
        <div class="viewer-container">
          <button class="position-btn left" onclick="router.navigate('/')">
            ← Exit
          </button>
          
          <button class="position-btn right ${copied ? 'copied' : ''}" onclick="copyLink()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              ${copied ? 
                '<polyline points="20 6 9 17 4 12"></polyline>' :
                '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>'
              }
            </svg>
            ${copied ? 'Copied!' : 'Share'}
          </button>
          
          <div style="max-width: 700px; width: 100%; text-align: center;">
            <h2 class="viewer-title">${whisper.title}</h2>
            
            ${whisper.slides.length === 0 ? 
              '<p style="color: #A08BAA; font-size: 16px;">No slides yet. Add some in the editor.</p>' :
              `<div class="slide-content" onclick="nextSlide()" style="${currentSlide < whisper.slides.length - 1 ? 'cursor: pointer;' : 'cursor: default;'}">
                <p class="slide-text">${slide.text || '(Empty slide)'}</p>
              </div>`
            }
            
            <div class="progress-dots">
              ${whisper.slides.map((_, i) => 
                `<div class="dot ${i === currentSlide ? 'active' : 'inactive'}"></div>`
              ).join('')}
            </div>
            
            ${currentSlide < whisper.slides.length - 1 && whisper.slides.length > 0 ?
              '<p style="margin-top: 24px; color: #A08BAA; font-size: 14px;">Tap to reveal next message</p>' : ''
            }
            
            ${currentSlide === whisper.slides.length - 1 && whisper.slides.length > 0 ?
              '<button class="btn btn-secondary" onclick="resetViewer()" style="margin-top: 24px;">Start over</button>' : ''
            }
          </div>
        </div>
      `;
    };
    
    window.nextSlide = () => {
      if (viewerState.currentSlide < viewerState.whisper.slides.length - 1) {
        viewerState.currentSlide++;
        renderViewer();
      }
    };
    
    window.resetViewer = () => {
      viewerState.currentSlide = 0;
      renderViewer();
    };
    
    window.copyLink = () => {
      const url = `${window.location.origin}${window.location.pathname}#/view/${viewerState.whisper.id}`;
      navigator.clipboard.writeText(url);
      viewerState.copied = true;
      renderViewer();
      setTimeout(() => {
        viewerState.copied = false;
        renderViewer();
      }, 2000);
    };
    
    // Initial render
    router.render();
  </script>
</body>
</html>